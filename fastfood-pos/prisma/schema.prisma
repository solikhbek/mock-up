generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ==================== USERS & AUTH ====================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  pin       String?
  password  String
  role      String   @default("CASHIER") // SUPER_ADMIN, DIRECTOR, MANAGER, CASHIER, COOK, WAREHOUSE, ACCOUNTANT
  branchId  String?
  branch    Branch?  @relation(fields: [branchId], references: [id])
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders    Order[]
  shifts    Shift[]
}

// ==================== BRANCHES ====================

model Branch {
  id        String   @id @default(cuid())
  name      String
  address   String
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]
  orders    Order[]
  inventory InventoryItem[]
  shifts    Shift[]
}

// ==================== MENU ====================

model Category {
  id        String   @id @default(cuid())
  name      String
  nameUz    String?
  icon      String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products  Product[]
}

model Product {
  id          String   @id @default(cuid())
  name        String
  nameUz      String?
  description String?
  price       Float
  image       String?
  categoryId  String
  category    Category @relation(fields: [categoryId], references: [id])
  isActive    Boolean  @default(true)
  inStock     Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orderItems  OrderItem[]
  modifiers   ProductModifier[]
  ingredients ProductIngredient[]
}

model ModifierGroup {
  id          String   @id @default(cuid())
  name        String
  nameUz      String?
  isRequired  Boolean  @default(false)
  minSelect   Int      @default(0)
  maxSelect   Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  modifiers   Modifier[]
  products    ProductModifier[]
}

model Modifier {
  id              String        @id @default(cuid())
  name            String
  nameUz          String?
  price           Float         @default(0)
  modifierGroupId String
  modifierGroup   ModifierGroup @relation(fields: [modifierGroupId], references: [id])
  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  orderItemModifiers OrderItemModifier[]
}

model ProductModifier {
  id              String        @id @default(cuid())
  productId       String
  product         Product       @relation(fields: [productId], references: [id])
  modifierGroupId String
  modifierGroup   ModifierGroup @relation(fields: [modifierGroupId], references: [id])

  @@unique([productId, modifierGroupId])
}

// ==================== ORDERS ====================

model Order {
  id            String    @id @default(cuid())
  orderNumber   Int
  branchId      String
  branch        Branch    @relation(fields: [branchId], references: [id])
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  status        String    @default("NEW") // NEW, PREPARING, READY, COMPLETED, CANCELLED
  type          String    @default("DINE_IN") // DINE_IN, TAKEAWAY
  subtotal      Float
  discount      Float     @default(0)
  total         Float
  paymentMethod String? // CASH, UZCARD, HUMO, VISA, MASTERCARD, CLICK, PAYME, UZUM
  paymentStatus String    @default("PENDING") // PENDING, PAID, REFUNDED
  note          String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  completedAt   DateTime?

  items         OrderItem[]
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Int
  price     Float
  total     Float
  note      String?
  createdAt DateTime @default(now())

  modifiers OrderItemModifier[]
}

model OrderItemModifier {
  id          String    @id @default(cuid())
  orderItemId String
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  modifierId  String
  modifier    Modifier  @relation(fields: [modifierId], references: [id])
  price       Float
}

// ==================== INVENTORY ====================

model Ingredient {
  id        String   @id @default(cuid())
  name      String
  nameUz    String?
  unit      String
  minStock  Float    @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  inventory InventoryItem[]
  products  ProductIngredient[]
  movements StockMovement[]
}

model InventoryItem {
  id           String     @id @default(cuid())
  ingredientId String
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])
  branchId     String
  branch       Branch     @relation(fields: [branchId], references: [id])
  quantity     Float      @default(0)
  updatedAt    DateTime   @updatedAt

  @@unique([ingredientId, branchId])
}

model ProductIngredient {
  id           String     @id @default(cuid())
  productId    String
  product      Product    @relation(fields: [productId], references: [id])
  ingredientId String
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])
  quantity     Float

  @@unique([productId, ingredientId])
}

model StockMovement {
  id           String     @id @default(cuid())
  ingredientId String
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])
  branchId     String
  type         String // IN, OUT, ADJUST, TRANSFER, WASTE
  quantity     Float
  reason       String?
  createdAt    DateTime   @default(now())
}

// ==================== FINANCE ====================

model Shift {
  id           String    @id @default(cuid())
  userId       String
  user         User      @relation(fields: [userId], references: [id])
  branchId     String
  branch       Branch    @relation(fields: [branchId], references: [id])
  openedAt     DateTime  @default(now())
  closedAt     DateTime?
  openingCash  Float     @default(0)
  closingCash  Float?
  expectedCash Float?
  status       String    @default("OPEN") // OPEN, CLOSED

  expenses     Expense[]
}

model Expense {
  id          String   @id @default(cuid())
  shiftId     String?
  shift       Shift?   @relation(fields: [shiftId], references: [id])
  branchId    String
  category    String // PURCHASE, SALARY, RENT, UTILITIES, OTHER
  amount      Float
  description String
  createdAt   DateTime @default(now())
}
